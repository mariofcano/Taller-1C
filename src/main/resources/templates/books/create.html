<!DOCTYPE html>
<!--
    PLANTILLA PARA CREACION DE NUEVOS USUARIOS EN EL PANEL ADMINISTRATIVO

    ESTA PAGINA PERMITE A LOS ADMINISTRADORES Y BIBLIOTECARIOS CREAR
    NUEVAS CUENTAS DE USUARIO EN EL SISTEMA. INCLUYE VALIDACIONES
    COMPLETAS, INTERFAZ INTUITIVA Y MANEJO ROBUSTO DE ERRORES.

    UTILIZO ESTILOS CENTRALIZADOS Y JAVASCRIPT MODULAR PARA MANTENER
    CONSISTENCIA CON EL RESTO DEL PANEL ADMINISTRATIVO.

    @author MARIO FLORES
    @version 1.0
    @since 2025-05-27
-->
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Usuario - Biblioteca Digital</title>

    <!-- CSS FRAMEWORKS EXTERNOS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <!-- ESTILOS CENTRALIZADOS DEL SISTEMA ADMINISTRATIVO -->
    <link rel="stylesheet" href="/css/admin-styles.css">
</head>
<body>
<!-- NAVBAR ADMINISTRATIVO REUTILIZABLE -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark navbar-admin">
    <div class="container">
        <a class="navbar-brand" href="/">
            <i class="fas fa-book-reader me-2"></i>
            Biblioteca Digital - Admin
        </a>

        <!-- NAVEGACION PRINCIPAL -->
        <div class="navbar-nav ms-auto">
            <a class="nav-link" href="/admin/users">
                <i class="fas fa-users me-1"></i>
                Usuarios
            </a>
            <a class="nav-link" href="/admin/books">
                <i class="fas fa-book me-1"></i>
                Libros
            </a>
            <a class="nav-link" href="/admin/loans">
                <i class="fas fa-handshake me-1"></i>
                Préstamos
            </a>
            <a class="nav-link" href="/logout">
                <i class="fas fa-sign-out-alt me-1"></i>
                Salir
            </a>
        </div>
    </div>
</nav>

<!-- HEADER DE LA SECCION -->
<div class="header-section">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="h2 mb-2">
                    <i class="fas fa-user-plus me-3"></i>
                    Crear Nuevo Usuario
                </h1>
                <p class="mb-0">Complete el formulario para registrar un nuevo usuario en el sistema</p>
            </div>
            <div class="col-md-4 text-end">
                <a href="/admin/users" class="btn btn-light">
                    <i class="fas fa-arrow-left me-2"></i>
                    Volver a Lista
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- MENSAJES DE ERROR/EXITO -->
    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <span th:text="${errorMessage}">Error</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- FORMULARIO DE CREACION -->
    <div class="admin-form">
        <form method="post" th:action="@{/admin/users/create}" id="createUserForm" novalidate>

            <!-- INFORMACION BASICA -->
            <div class="row mb-4">
                <div class="col-12">
                    <h4 class="border-bottom pb-2 mb-3">
                        <i class="fas fa-user-circle text-primary me-2"></i>
                        Información Básica
                    </h4>
                </div>
            </div>

            <div class="row">
                <!-- NOMBRE DE USUARIO -->
                <div class="col-md-6 mb-3">
                    <label for="username" class="form-label fw-bold">
                        <i class="fas fa-user me-2 text-primary"></i>
                        Nombre de Usuario *
                    </label>
                    <input type="text"
                           class="form-control form-control-lg"
                           id="username"
                           name="username"
                           th:value="${username}"
                           placeholder="ej: juan123"
                           required
                           pattern="^[a-zA-Z0-9_]{3,50}$"
                           maxlength="50">
                    <div class="form-text">
                        <i class="fas fa-info-circle me-1"></i>
                        Solo letras, números y guiones bajos (3-50 caracteres)
                    </div>
                    <div class="invalid-feedback"></div>
                </div>

                <!-- EMAIL -->
                <div class="col-md-6 mb-3">
                    <label for="email" class="form-label fw-bold">
                        <i class="fas fa-envelope me-2 text-primary"></i>
                        Correo Electrónico *
                    </label>
                    <input type="email"
                           class="form-control form-control-lg"
                           id="email"
                           name="email"
                           th:value="${email}"
                           placeholder="ejemplo@correo.com"
                           required
                           maxlength="100">
                    <div class="form-text">
                        <i class="fas fa-info-circle me-1"></i>
                        Dirección de email válida y única
                    </div>
                    <div class="invalid-feedback"></div>
                </div>
            </div>

            <!-- NOMBRE COMPLETO -->
            <div class="row">
                <div class="col-12 mb-3">
                    <label for="fullName" class="form-label fw-bold">
                        <i class="fas fa-id-card me-2 text-primary"></i>
                        Nombre Completo *
                    </label>
                    <input type="text"
                           class="form-control form-control-lg"
                           id="fullName"
                           name="fullName"
                           th:value="${fullName}"
                           placeholder="Juan Pérez García"
                           required
                           maxlength="100">
                    <div class="invalid-feedback"></div>
                </div>
            </div>

            <!-- CONTRASEÑAS -->
            <div class="row mb-4">
                <div class="col-12">
                    <h4 class="border-bottom pb-2 mb-3">
                        <i class="fas fa-key text-warning me-2"></i>
                        Configuración de Acceso
                    </h4>
                </div>
            </div>

            <div class="row">
                <!-- CONTRASEÑA -->
                <div class="col-md-6 mb-3">
                    <label for="password" class="form-label fw-bold">
                        <i class="fas fa-lock me-2 text-warning"></i>
                        Contraseña *
                    </label>
                    <div class="input-group">
                        <input type="password"
                               class="form-control form-control-lg"
                               id="password"
                               name="password"
                               placeholder="Mínimo 8 caracteres"
                               required
                               minlength="8"
                               maxlength="50">
                        <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div class="form-text">
                        <i class="fas fa-shield-alt me-1"></i>
                        Debe contener al menos 8 caracteres, letras y números
                    </div>
                    <div class="invalid-feedback"></div>
                </div>

                <!-- CONFIRMAR CONTRASEÑA -->
                <div class="col-md-6 mb-3">
                    <label for="confirmPassword" class="form-label fw-bold">
                        <i class="fas fa-lock me-2 text-warning"></i>
                        Confirmar Contraseña *
                    </label>
                    <input type="password"
                           class="form-control form-control-lg"
                           id="confirmPassword"
                           name="confirmPassword"
                           placeholder="Repita la contraseña"
                           required>
                    <div class="invalid-feedback"></div>
                </div>
            </div>

            <!-- ROL DEL USUARIO -->
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="role" class="form-label fw-bold">
                        <i class="fas fa-user-tag me-2 text-info"></i>
                        Rol del Usuario *
                    </label>
                    <select class="form-select form-select-lg" id="role" name="role" required>
                        <option value="">Seleccione un rol...</option>
                        <option th:each="roleOption : ${userRoles}"
                                th:value="${roleOption}"
                                th:text="${roleOption.description}"
                                th:selected="${role != null and role == roleOption}">
                            Rol
                        </option>
                    </select>
                    <div class="form-text">
                        <i class="fas fa-info-circle me-1"></i>
                        Define los permisos y accesos del usuario
                    </div>
                    <div class="invalid-feedback"></div>
                </div>

                <!-- ESTADO INICIAL -->
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">
                        <i class="fas fa-toggle-on me-2 text-success"></i>
                        Estado Inicial
                    </label>
                    <div class="form-check form-switch">
                        <input class="form-check-input"
                               type="checkbox"
                               id="active"
                               name="active"
                               value="true"
                               checked>
                        <label class="form-check-label fw-bold" for="active">
                            Usuario Activo
                        </label>
                    </div>
                    <div class="form-text">
                        <i class="fas fa-info-circle me-1"></i>
                        El usuario podrá acceder al sistema inmediatamente
                    </div>
                </div>
            </div>

            <!-- INFORMACION ADICIONAL -->
            <div class="row mb-4">
                <div class="col-12">
                    <h4 class="border-bottom pb-2 mb-3">
                        <i class="fas fa-address-card text-info me-2"></i>
                        Información de Contacto <small class="text-muted">(Opcional)</small>
                    </h4>
                </div>
            </div>

            <div class="row">
                <!-- TELEFONO -->
                <div class="col-md-6 mb-3">
                    <label for="phone" class="form-label fw-bold">
                        <i class="fas fa-phone me-2 text-info"></i>
                        Teléfono
                    </label>
                    <input type="tel"
                           class="form-control form-control-lg"
                           id="phone"
                           name="phone"
                           th:value="${phone}"
                           placeholder="+34 666 123 456"
                           pattern="^[+]?[0-9\s\-()]{7,15}$"
                           maxlength="20">
                    <div class="form-text">
                        <i class="fas fa-info-circle me-1"></i>
                        Número de contacto del usuario
                    </div>
                    <div class="invalid-feedback"></div>
                </div>

                <!-- CIUDAD/UBICACION -->
                <div class="col-md-6 mb-3">
                    <label for="city" class="form-label fw-bold">
                        <i class="fas fa-map-marker-alt me-2 text-info"></i>
                        Ciudad
                    </label>
                    <input type="text"
                           class="form-control form-control-lg"
                           id="city"
                           name="city"
                           placeholder="Madrid, España"
                           maxlength="50">
                    <div class="form-text">
                        <i class="fas fa-info-circle me-1"></i>
                        Ciudad de residencia del usuario
                    </div>
                </div>
            </div>

            <!-- DIRECCION COMPLETA -->
            <div class="row">
                <div class="col-12 mb-3">
                    <label for="address" class="form-label fw-bold">
                        <i class="fas fa-home me-2 text-info"></i>
                        Dirección Completa
                    </label>
                    <textarea class="form-control"
                              id="address"
                              name="address"
                              rows="3"
                              th:text="${address}"
                              placeholder="Calle, número, código postal, ciudad..."
                              maxlength="200"></textarea>
                    <div class="form-text">
                        <i class="fas fa-info-circle me-1"></i>
                        Dirección postal completa del usuario
                    </div>
                </div>
            </div>

            <!-- BOTONES DE ACCION -->
            <div class="row">
                <div class="col-12">
                    <hr class="my-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <!-- BOTONES IZQUIERDA -->
                        <div>
                            <a href="/admin/users" class="btn btn-outline-secondary btn-lg">
                                <i class="fas fa-times me-2"></i>
                                Cancelar
                            </a>
                        </div>

                        <!-- BOTONES DERECHA -->
                        <div>
                            <button type="reset" class="btn btn-outline-warning btn-lg me-2" id="resetForm">
                                <i class="fas fa-undo me-2"></i>
                                Limpiar Formulario
                            </button>
                            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                                <i class="fas fa-user-plus me-2"></i>
                                Crear Usuario
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </form>
    </div>

    <!-- INFORMACION ADICIONAL -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <i class="fas fa-info-circle me-2"></i>
                    Información sobre Roles
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <i class="fas fa-user-shield text-danger me-2"></i>
                            <strong>Administrador:</strong> Acceso completo al sistema
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-user-cog text-warning me-2"></i>
                            <strong>Bibliotecario:</strong> Gestión de libros y préstamos
                        </li>
                        <li class="mb-0">
                            <i class="fas fa-user text-info me-2"></i>
                            <strong>Usuario:</strong> Realizar préstamos y consultas
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <i class="fas fa-shield-alt me-2"></i>
                    Política de Contraseñas
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Mínimo 8 caracteres de longitud
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Debe contener al menos una letra
                        </li>
                        <li class="mb-0">
                            <i class="fas fa-check text-success me-2"></i>
                            Debe contener al menos un número
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SCRIPTS EXTERNOS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- JAVASCRIPT CENTRALIZADO -->
<script src="/js/admin-functions.js"></script>

<!-- JAVASCRIPT ESPECIFICO DE ESTA PAGINA -->
<script>
    /**
     * FUNCIONALIDADES ESPECIFICAS PARA EL FORMULARIO DE CREACION DE USUARIOS
     *
     * IMPLEMENTO AQUI LAS VALIDACIONES Y COMPORTAMIENTOS ESPECIFICOS
     * QUE SOLO APLICAN A ESTA PAGINA EN PARTICULAR.
     */
    document.addEventListener('DOMContentLoaded', function() {
        console.log('INICIALIZANDO FORMULARIO DE CREACION DE USUARIO...');

        /**
         * CONFIGURO TOGGLE DE VISIBILIDAD DE CONTRASEÑA
         *
         * PERMITO AL USUARIO VER/OCULTAR LA CONTRASEÑA MIENTRAS LA ESCRIBE
         * PARA FACILITAR LA ENTRADA DE DATOS Y REDUCIR ERRORES.
         */
        const togglePasswordBtn = document.getElementById('togglePassword');
        const passwordField = document.getElementById('password');

        if (togglePasswordBtn && passwordField) {
            togglePasswordBtn.addEventListener('click', function() {
                const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordField.setAttribute('type', type);

                // CAMBIO EL ICONO SEGUN EL ESTADO
                const icon = this.querySelector('i');
                icon.classList.toggle('fa-eye');
                icon.classList.toggle('fa-eye-slash');
            });
        }

        /**
         * VALIDACION EN TIEMPO REAL DE CONFIRMACION DE CONTRASEÑA
         *
         * VERIFICO QUE LAS CONTRASEÑAS COINCIDAN MIENTRAS EL USUARIO
         * ESCRIBE PARA PROPORCIONAR FEEDBACK INMEDIATO.
         */
        const confirmPasswordField = document.getElementById('confirmPassword');

        if (confirmPasswordField && passwordField) {
            function validatePasswordMatch() {
                const password = passwordField.value;
                const confirmPassword = confirmPasswordField.value;

                if (confirmPassword.length > 0) {
                    const isMatch = password === confirmPassword;

                    // APLICO CLASES DE VALIDACION VISUAL
                    confirmPasswordField.classList.remove('is-valid', 'is-invalid');
                    confirmPasswordField.classList.add(isMatch ? 'is-valid' : 'is-invalid');

                    // MUESTRO MENSAJE DE ERROR SI NO COINCIDEN
                    let feedback = confirmPasswordField.parentNode.querySelector('.invalid-feedback');
                    if (!feedback) {
                        feedback = document.createElement('div');
                        feedback.className = 'invalid-feedback';
                        confirmPasswordField.parentNode.appendChild(feedback);
                    }

                    feedback.textContent = isMatch ? '' : 'LAS CONTRASEÑAS NO COINCIDEN';
                    feedback.style.display = isMatch ? 'none' : 'block';

                    return isMatch;
                }

                return true;
            }

            // EVENTO EN AMBOS CAMPOS PARA VALIDACION CRUZADA
            passwordField.addEventListener('input', validatePasswordMatch);
            confirmPasswordField.addEventListener('input', validatePasswordMatch);
        }

        /**
         * VALIDACION ESPECIALIZADA PARA NOMBRE DE USUARIO
         *
         * VERIFICO EN TIEMPO REAL QUE EL NOMBRE DE USUARIO CUMPLA
         * CON EL PATRON ESTABLECIDO Y PROPORCIONO FEEDBACK VISUAL.
         */
        const usernameField = document.getElementById('username');

        if (usernameField) {
            usernameField.addEventListener('input', function() {
                const username = this.value;
                const pattern = /^[a-zA-Z0-9_]{3,50}$/;
                const isValid = pattern.test(username) && username.length >= 3;

                // APLICO VALIDACION VISUAL
                this.classList.remove('is-valid', 'is-invalid');

                if (username.length > 0) {
                    this.classList.add(isValid ? 'is-valid' : 'is-invalid');

                    // MENSAJE DE ERROR ESPECIFICO
                    let feedback = this.parentNode.querySelector('.invalid-feedback');
                    if (!feedback) {
                        feedback = document.createElement('div');
                        feedback.className = 'invalid-feedback';
                        this.parentNode.appendChild(feedback);
                    }

                    if (!isValid) {
                        if (username.length < 3) {
                            feedback.textContent = 'EL NOMBRE DE USUARIO DEBE TENER AL MENOS 3 CARACTERES';
                        } else if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                            feedback.textContent = 'SOLO SE PERMITEN LETRAS, NÚMEROS Y GUIONES BAJOS';
                        } else {
                            feedback.textContent = 'NOMBRE DE USUARIO NO VÁLIDO';
                        }
                        feedback.style.display = 'block';
                    } else {
                        feedback.style.display = 'none';
                    }
                }
            });
        }

        /**
         * FORMATEO AUTOMATICO DE TELEFONO
         *
         * APLICO FORMATEO VISUAL MIENTRAS EL USUARIO ESCRIBE
         * PARA MEJORAR LA EXPERIENCIA DE ENTRADA DE DATOS.
         */
        const phoneField = document.getElementById('phone');

        if (phoneField) {
            phoneField.addEventListener('input', function() {
                // PERMITO SOLO NUMEROS, ESPACIOS, PARENTESIS, GUIONES Y EL SIGNO +
                let value = this.value.replace(/[^\d+\s()-]/g, '');

                // LIMITO LA LONGITUD
                if (value.length > 20) {
                    value = value.substring(0, 20);
                }

                this.value = value;
            });
        }

        /**
         * BOTON DE RESET PERSONALIZADO
         *
         * CONFIRMO CON EL USUARIO ANTES DE LIMPIAR EL FORMULARIO
         * PARA EVITAR PERDIDA ACCIDENTAL DE DATOS.
         */
        const resetBtn = document.getElementById('resetForm');

        if (resetBtn) {
            resetBtn.addEventListener('click', function(e) {
                e.preventDefault();

                if (confirm('¿ESTÁ SEGURO DE LIMPIAR TODO EL FORMULARIO?\n\nSe perderán todos los datos ingresados.')) {
                    const form = document.getElementById('createUserForm');
                    form.reset();

                    // LIMPIO CLASES DE VALIDACION
                    form.querySelectorAll('.is-valid, .is-invalid').forEach(field => {
                        field.classList.remove('is-valid', 'is-invalid');
                    });

                    // OCULTO MENSAJES DE ERROR
                    form.querySelectorAll('.invalid-feedback').forEach(feedback => {
                        feedback.style.display = 'none';
                    });

                    // ENFOCO EL PRIMER CAMPO
                    const firstField = form.querySelector('input:not([type="hidden"])');
                    if (firstField) {
                        firstField.focus();
                    }

                    AdminFunctions.alerts.show('FORMULARIO LIMPIADO CORRECTAMENTE', 'info');
                }
            });
        }

        /**
         * VALIDACION FINAL ANTES DEL ENVIO
         *
         * EJECUTO UNA VALIDACION COMPLETA ANTES DE PERMITIR
         * EL ENVIO DEL FORMULARIO AL SERVIDOR.
         */
        const form = document.getElementById('createUserForm');

        if (form) {
            form.addEventListener('submit', function(e) {
                console.log('VALIDANDO FORMULARIO ANTES DEL ENVIO...');

                let isValid = true;
                const errors = [];

                // VALIDO CAMPOS REQUERIDOS
                const requiredFields = form.querySelectorAll('[required]');
                requiredFields.forEach(field => {
                    if (!field.value.trim()) {
                        isValid = false;
                        errors.push(`EL CAMPO ${field.previousElementSibling.textContent.toUpperCase()} ES REQUERIDO`);
                        field.classList.add('is-invalid');
                    }
                });

                // VALIDO COINCIDENCIA DE CONTRASEÑAS
                if (passwordField.value !== confirmPasswordField.value) {
                    isValid = false;
                    errors.push('LAS CONTRASEÑAS NO COINCIDEN');
                }

                // VALIDO PATRON DE NOMBRE DE USUARIO
                const usernamePattern = /^[a-zA-Z0-9_]{3,50}$/;
                if (!usernamePattern.test(usernameField.value)) {
                    isValid = false;
                    errors.push('EL NOMBRE DE USUARIO NO TIENE UN FORMATO VÁLIDO');
                }

                // VALIDO LONGITUD DE CONTRASEÑA
                if (passwordField.value.length < 8) {
                    isValid = false;
                    errors.push('LA CONTRASEÑA DEBE TENER AL MENOS 8 CARACTERES');
                }

                // VALIDO QUE LA CONTRASEÑA CONTENGA LETRAS Y NUMEROS
                if (!/[a-zA-Z]/.test(passwordField.value) || !/[0-9]/.test(passwordField.value)) {
                    isValid = false;
                    errors.push('LA CONTRASEÑA DEBE CONTENER AL MENOS UNA LETRA Y UN NÚMERO');
                }

                if (!isValid) {
                    e.preventDefault();
                    console.log('FORMULARIO NO VÁLIDO:', errors);

                    // MUESTRO TODOS LOS ERRORES
                    const errorMessage = 'ERRORES EN EL FORMULARIO:\n\n' + errors.join('\n');
                    AdminFunctions.alerts.show(errorMessage.replace(/\n/g, '<br>'), 'danger');

                    // ENFOCO EL PRIMER CAMPO CON ERROR
                    const firstInvalidField = form.querySelector('.is-invalid');
                    if (firstInvalidField) {
                        firstInvalidField.focus();
                    }

                    return false;
                }

                console.log('FORMULARIO VÁLIDO - ENVIANDO...');

                // DESHABILITO EL BOTON PARA EVITAR ENVIOS DUPLICADOS
                const submitBtn = document.getElementById('submitBtn');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>CREANDO USUARIO...';
                }
            });
        }

        console.log('FORMULARIO DE CREACION DE USUARIO INICIALIZADO CORRECTAMENTE');
    });
</script>
</body>
</html>